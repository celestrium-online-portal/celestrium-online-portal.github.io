<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Celestrium Online Portal</title>
        <meta name="app-version" content="2.8.0">
        <link rel="icon" type="image/x-icon" href="./favicon.ico?login.live.com">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

        <style>
            /* ROOT VARIABLES */
            :root {
                --bg: #f5f7fb;
                --card: #ffffff;
                --text: #1a1a1a;
                --accent: #4a90e2;
                --subtext: #777;
            }

            /* DARK MODE VARIABLES */
            body.dark {
                --bg: #121318;
                --card: #1f2128;
                --text: #e0e0e0;
                --subtext: #a0a0a0;
                --accent: #5ea8ff;
            }

            /* BODY */
            body {
                margin: 0;
                font-family: 'Inter', sans-serif;
                background: var(--bg);
                color: var(--text);
                transition: background .25s, color .25s;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            /* NAVBAR */
            nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 18px 30px;
                background: var(--card);
                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                position: sticky;
                top: 0;
                z-index: 50;
            }

            nav .logo {
                font-size: 1.4rem;
                font-weight: 700;
                color: var(--accent);
                cursor: pointer;
            }

            nav .links a {
                margin-left: 20px;
                font-weight: 500;
                text-decoration: none;
                color: var(--text);
                transition: color .2s;
                cursor: pointer;
            }

            nav .links a:hover {
                color: var(--accent);
            }

            /* PAGE CONTAINERS */
            .page {
                display: none;
                padding: 40px;
                max-width: 1100px;
                margin: auto;
                animation: fade .3s ease;
            }

            @keyframes fade {
                from { opacity:0; transform:translateY(6px); }
                to { opacity:1; transform:translateY(0); }
            }

            /* HERO */
            .hero {
                text-align: center;
                margin-top: 40px;
            }

            .hero h1 {
                font-size: 3rem;
                margin-bottom: 10px;
                font-weight: 800;
            }

            .hero p {
                color: var(--subtext);
                font-size: 1.15rem;
            }

            /* CARD GRID */
            .card-grid {
                margin-top: 50px;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 25px;
            }

            .card {
                background: var(--card);
                padding: 25px;
                border-radius: 14px;
                text-align: center;
                box-shadow: 0 2px 12px rgba(0,0,0,0.07);
                transition: transform .2s, box-shadow .2s;
            }

            .card.hoverable:hover {
                transform: translateY(-4px);
                box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            }

            /* SEARCH BAR */
            .search-bar {
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 15px;
                gap: 12px;
                flex-wrap: wrap;
            }

            .search-bar input[type="text"] {
                width: 60%;
                padding: 14px;
                border-radius: 10px;
                border: 1px solid #ccc;
                font-size: 1.1rem;
                background: var(--card);
                color: var(--text);
                transition: background .25s, color .25s, border-color .25s;
            }

            /* SCHOOL NOTE */
            .school-note {
                color: var(--subtext);
                text-align: center;
                margin-bottom: 12px;
                font-size: 0.95rem;
            }

            /* GAMES CONTAINER */
            .games-container {
                background: var(--card);
                padding: 26px;
                border-radius: 14px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            }

            .game-item {
                padding: 14px 18px;
                margin: 8px 0;
                border-radius: 10px;
                background: #eaf2ff;
                color: #1555a6;
                font-size: 1.1rem;
                text-decoration: none;
                display: block;
                transition: transform .2s, background .2s;
            }

            .game-item.hoverable:hover {
                background: #d8e9ff;
                transform: translateX(4px);
            }

            #no-results {
                padding: 50px 20px;
                text-align: center;
                color: var(--subtext);
                display: none;
            }

            #no-results svg {
                width: 85px;
                height: 85px;
                opacity: 0.5;
                margin-bottom: 10px;
            }

            /* ABOUT CARD */
            .about-card {
                background: var(--card);
                padding: 25px;
                border-radius: 14px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.1);
                transition: background .25s, color .25s, box-shadow .25s;
                width: 100%;
            }

            /* SETTINGS ROW */
            .setting-row {
                background: var(--card);
                padding: 20px;
                border-radius: 12px;
                margin-bottom: 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 1px 8px rgba(0,0,0,0.08);
                transition: background .25s, color .25s, box-shadow .25s;
            }

            .setting-row label,
            .setting-row select,
            .setting-row button {
                margin-left: 10px;
            }

            /* MODERN DROPDOWN */
            select#defaultFilter {
                padding: 8px 12px;
                border-radius: 8px;
                border: 1px solid #ccc;
                background: var(--card);
                color: var(--text);
                font-size: 1rem;
                cursor: pointer;
                transition: all .25s;
            }

            select#defaultFilter:hover {
                border-color: var(--accent);
            }

            select#defaultFilter:focus {
                outline: none;
                border-color: var(--accent);
                box-shadow: 0 0 5px rgba(74,144,226,0.5);
            }

            /* TOGGLE SWITCH */
            .switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 26px;
            }

            .switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 26px;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 22px;
                width: 22px;
                left: 2px;
                bottom: 2px;
                background: white;
                transition: .4s;
                border-radius: 50%;
            }

            input:checked + .slider {
                background-color: var(--accent);
            }

            input:checked + .slider:before {
                transform: translateX(24px);
            }

            /* DARK MODE */
            body.dark .game-item {
                background: #2a2c35;
                color: #a3c9ff;
            }

            body.dark .game-item.hoverable:hover {
                background: #3a3c46;
            }

            body.dark .search-bar input {
                background: #2a2c35;
                color: #e0e0e0;
                border-color: #555;
            }

            body.dark .games-container {
                background: #1f2128;
                box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            }

            body.dark .setting-row {
                background: #1f2128;
                box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            }

            body.dark nav {
                background: #1f2128;
                box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            }

            body.dark .card {
                background: #1f2128;
                color: #e0e0e0;
                box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            }

            body.dark .hero p {
                color: var(--subtext);
            }

            /* IFRAME */
            #iframeWrapper {
                display: none;
                width: 100%;
                height: calc(100vh - 70px);
            }

            #iframeWrapper iframe {
                width: 100%;
                height: 100%;
                border: none;
            }

            /* KEYBIND ROW */
            .keybind-row {
                display: flex;
                gap: 10px;
                align-items: center;
                margin-top: 10px;
            }

            .keybind-row input {
                padding: 10px 14px;
                font-size: 1rem;
                width: 240px;
                border-radius: 8px;
                border: 2px solid #ccc;
                background: var(--card);
                color: var(--text);
                font-weight: 500;
                transition: all 0.25s;
                box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
            }

            .keybind-row input:focus {
                border-color: var(--accent);
                box-shadow: 0 0 5px rgba(74,144,226,0.4);
            }

            .keybind-row button {
                padding: 8px 12px;
                cursor: pointer;
                border: none;
                border-radius: 6px;
                font-weight: 600;
                transition: background .2s;
            }

            .keybind-row button:hover {
                opacity: 0.85;
            }

            .save-btn {
                background: var(--accent);
                color: white;
            }

            .reset-btn {
                background: #ccc;
                color: #333;
            }

            /* ADVANCED RESET BUTTON */
            #resetButton {
                padding: 10px 18px;
                border-radius: 8px;
                border: none;
                background: var(--accent);
                color: white;
                font-weight: 600;
                cursor: pointer;
                transition: background .2s;
            }

            #resetButton:hover {
                background: #3a7bd5;
            }
        </style>
    </head>

    <body class="dark">
        
        <!-- NAVIGATION -->
        <nav>
            <div class="logo" onclick="showPage('home')"><img id="logoImg" src="./logo-dark.png?login.live.com" alt="Celestrium Online" style="height:50px;"></div>
            <div class="links">
                <a onclick="showPage('home')"><i class="fas fa-home"></i> Home</a>
                <a onclick="showPage('all')"><i class="fas fa-gamepad"></i> All Games</a>
                <a onclick="showPage('about')"><i class="fas fa-info-circle"></i> About</a>
                <a onclick="showPage('settings')"><i class="fas fa-cog"></i> Settings</a>
            </div>
        </nav>

        <!-- IFRAME -->
        <div id="iframeWrapper">
            <iframe id="gameIframe" src=""></iframe>
        </div>

        <!-- HOME PAGE -->
        <div id="home" class="page" style="display:block;">
            <div class="hero">
                <h1>Welcome to Celestrium Online THISISTEST</h1>
                <p>A Clean & Organized Portal to Play Your Favorite HTML Games</p>
            </div>

            <div class="card-grid">
                <div class="card hoverable">
                    <h2 id="mostPopularGamesHeader">Unable to Access This Content...</h2>
                    <p>We Only Include Popular & Fun Games That Are Worth Your Time</p>
                </div>
                <div class="card hoverable">
                    <h2>Works on All Accounts</h2>
                    <p id="elementaryWorkingGamesHeader">Unable to Access This Content...</p>
                </div>
                <div class="card hoverable">
                    <h2>Fast Search Available</h2>
                    <p>You Can Quickly Find Any Game</p>
                </div>
                <div class="card hoverable">
                    <h2>Light & Dark Mode Available</h2>
                    <p>You Can Switch Between Dark & Light Mode in Settings</p>
                </div>
                <div class="card hoverable">
                    <h2>"Escape" Keybind and Tab Cloak Available</h2>
                    <p>You Can Set an "Escape" Keybind & Tab Cloak in Settings</p>
                </div>
                <div class="card hoverable">
                    <h2>Regular Updates</h2>
                    <p>New Games Are Added Frequently to Keep The Collection Fresh & Fun</p>
                </div>
            </div>
        </div>

        <!-- ALL GAMES PAGE -->
        <div id="all" class="page">
            <h1 style="text-align: center;">All Games</h1>
            <p class="school-note">Use the search bar below to find a game. To filter for elementary & middle school compatible games, adjust the default game filter in Settings.</p>

            <div class="search-bar">
                <i class="fas fa-search" style="color: var(--subtext); font-size: 1.2rem;"></i>
                <input id="search" type="text" placeholder="Search Games...">
            </div>

            <div class="games-container">
                <div id="gameList"></div>
                <div id="no-results">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="3" y1="3" x2="21" y2="21"></line>
                    </svg>
                    <p>No games match your query. Please check your spelling or adjust your search term.</p>
                </div>
            </div>
        </div>

        <!-- ABOUT PAGE -->
        <div id="about" class="page">
            <h1 style="text-align: center;">About</h1>
            <div class="about-card">
                <h2>What Is Celestrium Online?</h2>
                <p>
                    Celestrium Online is a simple, fast, and well-organized portal built to make browsing HTML games easier.
                    Many game sites today are cluttered, confusing, or slow. This project aims to fix that by offering a clean
                    layout, a reliable search system, and smooth navigation.
                </p>
                <br>
                <h2>Why This Project Exists</h2>
                <p>
                    Celestrium Online started as a small passion project. I wanted to create something that felt smooth,
                    modern, and actually enjoyable to use. A lot of students, myself included, know the feeling of having a bit of downtime and wishing there was a simple place to play games without the clutter and confusion found on many sites.
                </p>
                <p>
                    Over time, this project grew into a full platform with a clean interface, fast loading times, and a focus
                    on making the experience as seamless as possible. Celestrium Online is built by a student, for students,
                    with the goal of offering something polished, organized, and genuinely fun to use.
                </p>
                <br>
                <h2>How It Works</h2>
                <p>
                    All games are loaded using lightweight HTML, CSS, and JavaScript. The site is designed to work smoothly
                    on school computers, Chromebooks, and personal devices. Every page loads instantly thanks to optimized
                    assets and a focused layout.
                </p>
                <br>
                <h2>Credits</h2>
                <p>Created and maintained by the Celestrium Online team.</p>
            </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div id="settings" class="page">
            <h1 style="text-align: center;">Settings</h1>

            <!-- SITE AESTHETICS -->
            <h2 style="margin-bottom: 10px;">Site Aesthetics</h2>
            <div class="setting-row">
                <span>Dark Mode</span>
                <label class="switch">
                    <input type="checkbox" id="darkToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-row">
                <span>Animations</span>
                <label class="switch">
                    <input type="checkbox" id="animationsToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <!-- GAME ORGANIZATION -->
            <h2 style="margin-bottom: 10px;">Game Organization</h2>
            <div class="setting-row">
                <span>Default Game Filter</span>
                <select id="defaultFilter">
                    <option value="all">All Games</option>
                    <option value="elem-middle" selected>Elementary & Middle School Only</option>
                </select>
            </div>

            <!-- PRIVACY TOOLS -->
            <h2 style="margin-bottom: 10px;">Privacy Tools</h2>
            <div class="setting-row">
                <span>Escape Keybind</span>
                <div class="keybind-row">
                    <input type="text" id="keybindInput" placeholder="Press Key Combination" readonly>
                    <button class="save-btn" id="saveKeybindBtn">Save</button>
                    <button class="reset-btn" id="resetKeybindBtn">Reset</button>
                </div>
            </div>

            <div class="setting-row">
                <span>Tab Cloak Title</span>
                <div class="keybind-row" style="align-items:center;">
                    <input type="text" id="cloakInput" placeholder="Enter New Page Title">
                    <button class="save-btn" id="saveCloakBtn">Save</button>
                    <button class="reset-btn" id="resetCloakBtn">Reset</button>
                </div>
            </div>

            <div class="setting-row">
                <span>Favicon (Tab Icon)</span>
                <div class="keybind-row" style="align-items:center;">
                    <input type="text" id="faviconInput" placeholder="Enter Full Favicon URL">
                    <input type="file" id="faviconFileInput" accept="image/*" style="display:none">
                    <button class="save-btn" id="uploadFaviconBtn" style="margin-left:8px;padding:8px 10px;">Upload</button>
                    <span id="faviconFileName" style="margin-left:8px;color:var(--subtext);font-size:0.95rem;"></span>
                    <button class="save-btn" id="saveFaviconBtn">Save</button>
                    <button class="reset-btn" id="resetFaviconBtn">Reset</button>
                    
                </div>
            </div>

            <!-- ADVANCED -->
            <h2 style="margin-bottom: 10px;">Advanced</h2>
            <div class="setting-row">
                <button id="resetButton">Reset to Default</button>
            </div>
        </div>

        <script src="./games.js?login.live.com"></script>
        <script>
            /* VARIABLES */
            const logo = document.getElementById("logoImg");
            const darkToggle = document.getElementById("darkToggle");
            const defaultFilter = document.getElementById("defaultFilter");
            const listEl = document.getElementById("gameList");
            const searchEl = document.getElementById("search");
            const noResultsEl = document.getElementById("no-results");
            const animationsToggle = document.getElementById("animationsToggle");
            const iframeWrapper = document.getElementById("iframeWrapper");
            const gameIframe = document.getElementById("gameIframe");
            const keybindInput = document.getElementById("keybindInput");
            const saveKeybindBtn = document.getElementById("saveKeybindBtn");
            const resetKeybindBtn = document.getElementById("resetKeybindBtn");
            const mostPopularGamesHeader = document.getElementById("mostPopularGamesHeader");
            const elementaryWorkingGamesHeader = document.getElementById("elementaryWorkingGamesHeader");

            const cloakInput = document.getElementById("cloakInput");
            const saveCloakBtn = document.getElementById("saveCloakBtn");
            const resetCloakBtn = document.getElementById("resetCloakBtn");
            const ORIGINAL_TITLE = document.title;
            const faviconInput = document.getElementById("faviconInput");
            const faviconFileInput = document.getElementById("faviconFileInput");
            const saveFaviconBtn = document.getElementById("saveFaviconBtn");
            const resetFaviconBtn = document.getElementById("resetFaviconBtn");
            const uploadFaviconBtn = document.getElementById("uploadFaviconBtn");
            const faviconFileName = document.getElementById("faviconFileName");
            
            const faviconLinkEl = document.querySelector('link[rel~="icon"]');
            const ORIGINAL_FAV_HREF = faviconLinkEl ? faviconLinkEl.getAttribute('href') : null;
            let pendingFaviconDataUrl = null;
            let faviconUrlValid = false;
            let lastValidatedUrl = null;

            let escapeKeybind = null;
            let tempKeybind = null;
            let settingKeybind = false;
            let pendingCloakTitle = null;

            /* NAVIGATION */
            function showPage(id) {
                iframeWrapper.style.display = "none";
                gameIframe.src = "";
                document.querySelectorAll('.page').forEach(p => p.style.display = "none");
                document.getElementById(id).style.display = "block";
            }

            /* DARK MODE */
            darkToggle.checked = true;
            darkToggle.addEventListener("change", e => {
                document.body.classList.toggle("dark", e.target.checked);
                if (darkToggle.checked) {
                    logo.src = "./logo-dark.png?login.live.com";
                } else {
                    logo.src = "./logo-light.png?login.live.com";
                }
            });

            /* ANIMATIONS */
            function updateAnimations() {
                const enable = animationsToggle.checked;

                document.querySelectorAll('#home .card').forEach(el => {
                    if (enable) el.classList.add('hoverable'); else el.classList.remove('hoverable');
                });

                document.querySelectorAll('#all .game-item').forEach(el => {
                    if (enable) el.classList.add('hoverable'); else el.classList.remove('hoverable');
                });
            }

            animationsToggle.addEventListener("change", updateAnimations);
            updateAnimations();

            mostPopularGamesHeader.textContent = Math.floor(games.length/5)*5 + "+ of the Most Popular Games"
            var elmWorkingGames = 0;
            games.forEach(game => {
                if (game.grade === "all-grades") {
                    elmWorkingGames++;
                }
            });
            elementaryWorkingGamesHeader.textContent = elmWorkingGames + "/" + games.length + " of Our Games Are Elementary & Middle School Compatible"

            /* RENDER GAMES */
            function renderGames() {
                const query = searchEl.value.toLowerCase();
                const filter = defaultFilter.value;
                listEl.innerHTML = "";
                let count = 0;

                games.forEach(g => {
                    const matchesQuery = g.name.toLowerCase().includes(query);
                    const matchesFilter = filter === "all" || g.grade === "all-grades";

                    if (matchesQuery && matchesFilter) {
                        const a = document.createElement("a");
                        a.className = "game-item hoverable";
                        a.href = "#";
                        a.textContent = g.name;

                        a.addEventListener("click", e => {
                            e.preventDefault();
                            iframeWrapper.style.display = "block";
                            gameIframe.src = g.url + "?login.live.com";
                            document.querySelectorAll('.page').forEach(p => p.style.display = "none");
                        });

                        listEl.appendChild(a);
                        count++;
                    }
                });

                noResultsEl.style.display = count === 0 ? "block" : "none";
                updateAnimations(); // Ensures animations toggle is respected
            }

            searchEl.addEventListener("input", renderGames);
            defaultFilter.addEventListener("change", renderGames);
            renderGames();

            /* RESET BUTTON */
            document.getElementById("resetButton").addEventListener("click", () => {
                // Reset dark mode
                darkToggle.checked = false;
                document.body.classList.remove("dark");

                // Reset animations
                animationsToggle.checked = true;
                updateAnimations();

                // Reset game filter and search
                defaultFilter.value = "all";
                searchEl.value = "";
                renderGames();

                // Reset keybinds
                escapeKeybind = null;
                keybindInput.value = "";

                // Reset cloaked title
                document.title = ORIGINAL_TITLE;

                // Reset cloaked favicon
                // restore original favicon
                if (ORIGINAL_FAV_HREF) setFavicon(ORIGINAL_FAV_HREF);
            });

            /* KEYBIND HANDLERS */
            keybindInput.addEventListener("focus", () => {
                settingKeybind = true;
                tempKeybind = null;
                keybindInput.value = "";
            });

            keybindInput.addEventListener("keydown", e => {
                e.preventDefault();
                const parts = [];

                if (e.ctrlKey) parts.push("Ctrl");
                if (e.metaKey) parts.push(navigator.platform.includes("Mac") ? "Cmd" : "Meta");
                if (e.altKey) parts.push("Alt");
                if (e.shiftKey) parts.push("Shift");

                const mainKey = e.key.length === 1 ? e.key.toUpperCase() : null;
                if (mainKey) parts.push(mainKey);

                keybindInput.value = parts.join(" + ");
                tempKeybind = {
                    ctrl: e.ctrlKey,
                    meta: e.metaKey,
                    alt: e.altKey,
                    shift: e.shiftKey,
                    key: mainKey ? e.key.toLowerCase() : null,
                    display: parts.join(" + ")
                };
            });

            saveKeybindBtn.addEventListener("click", () => {
                if (tempKeybind && tempKeybind.key) {
                    escapeKeybind = tempKeybind;
                    alert("Keybind saved: " + escapeKeybind.display + "\n\nYou can use this keybind to escape to Schoology, except when your computer is focused on a game. This will close your tab, so be careful not to do it on accident.");
                }
                keybindInput.value = escapeKeybind ? escapeKeybind.display : "";
                settingKeybind = false;
            });

            resetKeybindBtn.addEventListener("click", () => {
                escapeKeybind = null;
                tempKeybind = null;
                keybindInput.value = "";
                settingKeybind = false;
            });

            /* ESCAPE KEY TRIGGER */
            document.addEventListener("keydown", e => {
                if (settingKeybind || !escapeKeybind || !escapeKeybind.key) return;

                if (e.key.toLowerCase() === escapeKeybind.key &&
                    e.ctrlKey === !!escapeKeybind.ctrl &&
                    e.metaKey === !!escapeKeybind.meta &&
                    e.altKey === !!escapeKeybind.alt &&
                    e.shiftKey === !!escapeKeybind.shift) {
                    window.location.href = "https://nsd.schoology.com";
                }
            });

            /* TAB CLOAK: load, preview, save, reset */
            (function(){
                // load stored cloaked title
                try {
                    // Do not load any stored cloaked title from localStorage; start fresh each session
                    if (cloakInput) cloakInput.value = '';
                } catch (e) {}

                if (cloakInput) {
                    cloakInput.addEventListener('input', (e) => {
                        const v = e.target.value.trim();
                        pendingCloakTitle = v || null;
                    });
                }

                if (saveCloakBtn) {
                    saveCloakBtn.addEventListener('click', () => {
                        const v = (pendingCloakTitle !== null) ? pendingCloakTitle : (cloakInput ? cloakInput.value.trim() : '');
                        try {
                            if (v) {
                                // Apply title for this session only (do not persist to localStorage)
                                document.title = v;
                                alert('Tab title saved: ' + v + "\n\nThis will change the text shown in your browser tab for this session.");
                            } else {
                                document.title = ORIGINAL_TITLE;
                                alert('Tab title cleared; using default.');
                            }
                        } catch (e) {
                            alert('Could not save setting: ' + e.message);
                        }
                        pendingCloakTitle = null;
                    });
                }

                if (resetCloakBtn) {
                    resetCloakBtn.addEventListener('click', () => {
                        if (cloakInput) cloakInput.value = '';
                        pendingCloakTitle = null;
                        document.title = ORIGINAL_TITLE;
                        alert('Tab cloak reset to default.');
                    });
                }
                // FAVICON HANDLERS
                function setFavicon(href) {
                    try {
                        let el = document.querySelector('link[rel~="icon"]');
                        if (!el) {
                            el = document.createElement('link');
                            el.rel = 'icon';
                            document.getElementsByTagName('head')[0].appendChild(el);
                        }
                        el.href = href || '';
                    } catch (e) {}
                }

                // validate an image URL by attempting to load it
                function validateImageUrl(url) {
                    return new Promise(resolve => {
                        if (!url) return resolve(false);
                        const img = new Image();
                        let done = false;
                        img.crossOrigin = 'anonymous';
                        img.onload = function() {
                            if (done) return; done = true;
                            lastValidatedUrl = url; faviconUrlValid = true; resolve(true);
                        };
                        img.onerror = function() {
                            if (done) return; done = true;
                            lastValidatedUrl = url; faviconUrlValid = false; resolve(false);
                        };
                        img.src = url;
                        // timeout after 5s
                        setTimeout(() => { if (done) return; done = true; lastValidatedUrl = url; faviconUrlValid = false; resolve(false); }, 5000);
                    });
                }

                function urlHasAllowedExtension(url) {
                    try {
                        const u = url.split('?')[0].split('#')[0];
                        const ext = u.slice(u.lastIndexOf('.') + 1).toLowerCase();
                        return ['png','jpg','jpeg','ico'].includes(ext);
                    } catch (e) { return false; }
                }

                // Do not load any stored cloaked favicon; start fresh each session
                try {
                    if (faviconInput) faviconInput.value = '';
                    faviconUrlValid = false; lastValidatedUrl = null;
                } catch (e) {}

                if (faviconInput) {
                    faviconInput.addEventListener('input', (e) => {
                        // typing a URL clears any pending uploaded file
                        pendingFaviconDataUrl = null;
                        if (faviconFileName) faviconFileName.textContent = '';
                        // do not validate while typing; defer validation until Save
                        const v = e.target.value.trim();
                        if (!v) {
                            faviconUrlValid = false;
                            lastValidatedUrl = null;
                        } else {
                            // keep the typed value but mark as not-yet-validated
                            faviconUrlValid = false;
                            lastValidatedUrl = null;
                        }
                    });
                }

                if (faviconFileInput) {
                    faviconFileInput.addEventListener('change', (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;
                        // quick file type and extension check (allow png, jpg/jpeg, ico)
                        const name = (file.name || '').toLowerCase();
                        const ext = name.slice(name.lastIndexOf('.') + 1);
                        const allowedExt = ['png','jpg','jpeg','ico'];
                        const allowedTypes = ['image/png','image/jpeg','image/x-icon','image/vnd.microsoft.icon','image/ico'];
                        if (!allowedExt.includes(ext) || !allowedTypes.includes(file.type)) {
                            alert('Please select a .png, .jpg/.jpeg, or .ico image file.');
                            faviconFileInput.value = '';
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            const dataUrl = ev.target.result;
                            pendingFaviconDataUrl = dataUrl;
                            if (faviconInput) faviconInput.value = '';
                            if (faviconFileName) faviconFileName.textContent = file.name || '';
                            faviconUrlValid = true; lastValidatedUrl = null;
                        };
                        reader.readAsDataURL(file);
                    });
                    // custom upload button wiring
                    if (uploadFaviconBtn) {
                        uploadFaviconBtn.addEventListener('click', (ev) => {
                            ev.preventDefault();
                            if (faviconFileInput) faviconFileInput.click();
                        });
                    }
                }

                if (saveFaviconBtn) {
                    saveFaviconBtn.addEventListener('click', () => {
                        // prefer uploaded data URL if present
                        const typed = faviconInput ? faviconInput.value.trim() : '';
                        const v = pendingFaviconDataUrl || typed;
                        try {
                            if (pendingFaviconDataUrl) {
                                // uploaded image already validated; apply for this session only
                                setFavicon(pendingFaviconDataUrl);
                                pendingFaviconDataUrl = null;
                                if (faviconFileInput) faviconFileInput.value = '';
                                if (faviconInput) faviconInput.value = '';
                                if (faviconFileName) faviconFileName.textContent = '';
                                alert('Favicon saved.\n\nThis will change the tab icon shown in your browser for this session.');
                                return;
                            }

                            if (v) {
                                // typed URL: if already validated and matches, save immediately
                                if (lastValidatedUrl === typed && faviconUrlValid) {
                                    // apply typed URL for this session only
                                    setFavicon(typed);
                                    alert('Favicon saved: ' + typed + "\n\nThis will change the tab icon shown in your browser for this session.");
                                    return;
                                }
                                    // otherwise validate now before saving
                                    if (!urlHasAllowedExtension(typed)) { alert('Invalid file type â€” allowed: png, jpg, ico'); return; }
                                    validateImageUrl(typed).then(valid => {
                                        if (valid) {
                                            setFavicon(typed);
                                            if (faviconFileName) faviconFileName.textContent = '';
                                            alert('Favicon saved: ' + typed + "\n\nThis will change the tab icon shown in your browser for this session.");
                                        } else {
                                            alert('Could not save favicon: the URL did not load as an image.');
                                        }
                                    });
                            } else {
                                // restore original (do not persist any change)
                                if (ORIGINAL_FAV_HREF) setFavicon(ORIGINAL_FAV_HREF);
                                alert('Favicon cleared; using default.');
                            }
                        } catch (e) {
                            alert('Could not save favicon: ' + e.message);
                        }
                    });
                }

                if (resetFaviconBtn) {
                    resetFaviconBtn.addEventListener('click', () => {
                        if (faviconInput) faviconInput.value = '';
                        if (faviconFileInput) faviconFileInput.value = '';
                        pendingFaviconDataUrl = null;
                        faviconUrlValid = false; lastValidatedUrl = null;
                        // restore original
                        if (ORIGINAL_FAV_HREF) setFavicon(ORIGINAL_FAV_HREF);
                        if (faviconFileName) faviconFileName.textContent = '';
                        alert('Favicon reset to default.');
                    });
                }
            })();
        </script>

        <!-- Auto-reload on navbar click if new version detected -->
        <script>
            (function() {
                let currentVersion = document.querySelector('meta[name="app-version"]')?.content;
                let updateAvailable = false;
                
                const checkForUpdates = async () => {
                    try {
                        const response = await fetch(window.location.href, { cache: 'no-store' });
                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newVersion = doc.querySelector('meta[name="app-version"]')?.content;
                        
                        if (newVersion && newVersion !== currentVersion) {
                            updateAvailable = true;
                            console.log('New version available:', newVersion);
                        }
                    } catch (error) {
                        console.log('Version check failed (offline?)', error);
                    }
                };
                
                // Check for updates every minute
                setInterval(checkForUpdates, 60 * 1000);
                
                // Reload on navbar link click if update available
                const navLinks = document.querySelectorAll('nav .links a');
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        if (updateAvailable) {
                            e.preventDefault();
                            location.reload();
                        }
                    });
                });
            })();
        </script>

    </body>
</html>
